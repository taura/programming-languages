# Go
#minc := ../go/minc/minc
# Julia
#minc := ../jl/minc/minc.jl
# OCaml
#minc := ../ml/minc/_build/default/bin/main.exe
# Rust
#minc := ../rs/minc/target/debug/minc
# or you might use the release verson
# minc := ../rs/minc/target/release/minc

ifndef minc
$(error "YOU MUST SET MINC VARIABLE IN MAKEFILE")
endif

# all the C files to be tested
srcs := $(sort $(wildcard src/f*.c))
# you can change it to test only a few files. e.g., 
# srcs := $(wildcard src/f00.c) # only f00
# srcs := $(wildcard src/f0?.c) # f00 ... f09

#
# don't have to change anything below
#
test_nos := $(patsubst src/f%.c,%,$(srcs))
minc_xmls := $(patsubst %,xml/f%.xml, $(test_nos))
minc_asms := $(patsubst %,asm/f%.s,   $(test_nos))
minc_exes := $(patsubst %,minc/f%.exe,$(test_nos))
gcc_exes  := $(patsubst %,gcc/f%.exe, $(test_nos))
minc_outs := $(patsubst %,out/f%.minc,$(test_nos))
gcc_outs  := $(patsubst %,out/f%.gcc, $(test_nos))
compares  := $(patsubst %,out/f%.diff,$(test_nos))

# compare results of gcc-generated executable
# and your-compiler-generated executable
all : $(compares)

# C -> XML
$(minc_xmls) : xml/f%.xml : src/f%.c xml/dir
	@echo "# convert $< to $@"
	python3 ../parser/minc_to_xml.py $< > $@

# XML -> asm
$(minc_asms) : asm/f%.s : xml/f%.xml asm/dir $(minc)
	@echo "# compile $< to asm with your minC compiler"
	$(minc) $< $@

# asm -> exe (by minc)
$(minc_exes) : minc/f%.exe : asm/f%.s main.c minc/dir
	@echo "# generate the executable that calls f with your minC compiler"
	gcc -o $@ -DTEST_NO=$(shell seq $* $*) main.c $< -O0 -g

# run exe (by minc) -> output
$(minc_outs) : out/f%.minc : minc/f%.exe out/dir
	@echo "# run the executable generated by gcc"
	$< | tee $@

# C -> exe (by gcc)
$(gcc_exes) : gcc/f%.exe : src/f%.c main.c gcc/dir
	@echo "# generate the executable that calls f with gcc"
	gcc -o $@ -DTEST_NO=$(shell seq $* $*) main.c $< -O0 -g

# run exe (by minc) -> output
$(gcc_outs) : out/f%.gcc : gcc/f%.exe out/dir
	@echo "# run the executable generated by gcc"
	$< | tee $@

# compare the two outputs
$(compares) : out/f%.diff : out/f%.minc out/f%.gcc
	@echo "# take the diff of the two"
	diff out/f$*.gcc out/f$*.minc > $@

xml/dir asm/dir gcc/dir minc/dir out/dir :
	mkdir -p $@

clean :
	rm -rf xml asm gcc minc out

.DELETE_ON_ERROR:
